<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Add Event</title>
    <link rel="stylesheet" href="styles-head1.css">
    <link rel="icon" href="icon/inlover.png" type="image/png">
    <script>
        // เมื่อหน้าเว็บโหลดเสร็จ
        var isLoggedIn = localStorage.getItem('isLoggedIn');
        console.log(isLoggedIn);
        // ถ้ายังไม่ได้ล็อกอิน ให้เปลี่ยนเส้นทางไปยังหน้า login.html
        if (isLoggedIn === 'false') {
            window.location.href = 'login.html';
        }else if (isLoggedIn === null || isLoggedIn === undefined || isLoggedIn === ''){
            window.location.href = 'login.html';
        }
    </script>
    <style>
/* ส่วนของการอัพโหลด */
.upload-post{
    width: 100%;
    padding-left: 120px;
    font-size: 0.9rem;
}
.upload-post h2{
    padding: 0.5rem;
}
.upload-post label{
    margin-right: 0.5rem;
}
.upload-post form{
    width: 100%;
    display: flex;
}
.upload-post form input#image{
    width: 10rem;
}
.upload-post form input[type="submit"]{
    margin-left: 0.5rem;
    margin-left: 0.5rem;
    width: 5rem;
    height: 3rem;
    font-size: 0.8rem;
    border-radius: 4px;
    font-weight: 600;
    text-transform: uppercase;
    -webkit-transition: all 200ms linear;
    transition: all 200ms linear;
    background-color: #ffeba7;
    color: #000000;   
}
.upload-post form input[type="submit"]:hover{
    background-color: #000000;
    color: #ffeba7;
    box-shadow: 0 8px 24px 0 rgba(16, 39, 112, .2);
}
.upload-post textarea#texth{
    /* margin-left: rem; */
    width: 10rem;
    height: 5rem;
}
.upload-post textarea#text{
    margin-left: 1rem;
    width: 20rem;
    height: 10rem;
}
#card-container {
    /* background-color: #c3cff4; */
    display: flex;
    flex-direction: column-reverse;
    overflow-y: auto;
    padding: 10px; /* เพิ่ม Padding เพื่อให้การ์ดไม่ติดขอบ */
    margin: 0;
    width: 100%;
    height: 60vh;
}
#card-container .card {
    display: flex;
    padding: 10px; /* ระยะห่างระหว่างการ์ด */
    /* background-color: bisque; */
    width: 100%; /* ขนาดขั้นต่ำของการ์ด */

}

/* เพิ่มข้อมูลสำหรับรูปภาพ */
#card-container .card-img {
    width: 28rem;
    height: 18rem;
    overflow: hidden;
    border-radius: 0.5rem;

}

#card-container .card-img img {
    width: 100%;
    height: auto;
}
.list-post{
    padding-left: 100px;
}
/* ส่วนของข้อความที่แสดง */
.information h3{
    padding: 0.2rem;
    font-size: 0.9rem;
}

.information textarea{
    width: 20rem;
    height: 10rem;
    font-size: 0.9rem;
}

.information p{
    padding: 0.1rem 0rem;
    font-size: 0.8rem;
}
/* ปุ่มกดอนุมัติและไม่อนุมัติ */
.buttons{
    /* padding: 1rem; */
}
.buttons .edit-btn,.delete-btn{
    font-size: 0.8rem;
    border-radius: 4px;
    height: 3rem;
    font-weight: 600;
    text-transform: uppercase;
    -webkit-transition: all 200ms linear;
    transition: all 200ms linear;
    padding: 0 20px;
    /* letter-spacing: 1px; */
    align-items: center;
    background-color: #ffeba7;
    color: #000000;
    margin: 0;
}

.buttons .edit-btn:hover,.delete-btn:hover{
    background-color: #000000;
    color: #ffeba7;
    box-shadow: 0 8px 24px 0 rgba(16, 39, 112, .2);
}
    </style>
</head>
<body>
    <!-- Sidebar Menu -->
    <div class="sidebar">
        <div class="profile">
            <!-- Change the src to the URL of the person icon -->
            <ion-icon name="person-outline"></ion-icon>
        </div>
        <ul class="menu">
            <span>Menu</span>
            <!-- <li>
                <a href="control.html">
                    <ion-icon name="home-outline"></ion-icon>
                    <p>Control</p>
                </a>
            </li> -->
            <li>
                <a href="add-event.html">
                    <ion-icon name="add-circle-outline"></ion-icon>
                    <p>Add Event</p>
                </a>
            </li>
            <!-- <li>
                <a href="notifications.html">
                    <ion-icon name="notifications-outline"></ion-icon>
                    <p>Notifications</p>
                </a>
            </li>  -->
            <li class="checkbox">
                <a href="user-permission.html">
                    <ion-icon name="checkbox-outline"></ion-icon>
                    <p>User Permission</p>
                </a>
            </li>
            <li class="data_user">
                <a href="data-user.html">
                    <ion-icon name="document-outline"></ion-icon>
                    <p>Data User</p>
                </a>
            </li>
            <li class="Chat">
                <a href="chat-user.html">
                    <ion-icon name="chatbox-outline"></ion-icon>
                    <p>Chat</p>
                </a>
            </li>
            <!-- <li class="switch-theme">
                <a href="#">
                    <ion-icon name="moon-outline"></ion-icon>
                    <p>Dark Mode</p>
                    <button>
                        <div class="circle"></div>
                    </button>
                </a>
            </li> -->
            <!-- <li>
                <a href="control.html">
                    <ion-icon name="headset-outline"></ion-icon>
                    <p>Contact admin</p>
                </a>
            </li> -->
            <li>
                <a href="logout.php">
                    <ion-icon name="log-out-outline"></ion-icon>
                    <p>Logout</p>
                </a>
            </li>
        </ul>
    </div>
    <!-- Ionicons -->
    <script
        type="module"
        src="https://cdn.jsdelivr.net/npm/ionicons@7.1.0/dist/ionicons/ionicons.esm.js"></script>
    <script
        nomodule
        src="https://cdn.jsdelivr.net/npm/ionicons@7.1.0/dist/ionicons/ionicons.js"></script>
    <!-- Add the script to use Ionicons through CDN -->
    <script
        type="module"
        src="https://cdn.jsdelivr.net/npm/ionicons@7.1.0/dist/ionicons/ionicons.esm.js"></script>
    <script
        nomodule
        src="https://cdn.jsdelivr.net/npm/ionicons@7.1.0/dist/ionicons/ionicons.js"></script>


    <div class="upload-post">
        <h2>อัพโหลดข้อมูลข่าวสาร</h2>
        <form action="add-event-upload.php" method="post" enctype="multipart/form-data">
            <label for="image">เลือกรูปภาพ</label><br>
            <input type="file" id="image" name="image" accept="image/*"><br>
            <textarea id="texth" name="texth" placeholder="หัวข้อ"></textarea><br>
            <textarea id="text" name="text" placeholder="รายละเอียด"></textarea><br>
            <input type="submit" value="Upload" name="submit">
        </form>
    </div>
    <section class="list-post" >
        <div class="card-container" id="card-container">
            <!-- การ์ดจะถูกสร้างโดย JavaScript -->
        </div>
    </section>
</body>
<script>
document.addEventListener('DOMContentLoaded', function () {
    const cardContainer = document.getElementById('card-container');

    function fetchAndRenderData() {
        fetch('add-event-show.php')
            .then(response => response.json())
            .then(data => {
                // เคลียร์ข้อมูลที่มีอยู่ใน cardContainer
                cardContainer.innerHTML = '';
                data.forEach(item => {
                    const card = document.createElement('div');
                    card.classList.add('card');
                    card.innerHTML = `
                    <div class="card-img">
                        <img src="${item.post_image}" alt="${item.post_image}">
                    </div>
                    <div class="information">
                        <h3>ข้อความที่โพส รหัส ${item.post_id}<h3>
                        <textarea id="texth" name="texth">${item.post_texth}</textarea>
                        <textarea id="text" name="text">${item.post_text}</textarea>
                        <p>${item.post_time}</p>
                    <div>
                    <div class="buttons">
                        <button class="edit-btn" type="submit" name="">edit</button>
                        <button class="delete-btn">delete</button>
                    </div>
                    `;
                    cardContainer.appendChild(card);
                    
                    const editBtn = card.querySelector('.edit-btn');
                    const deleteBtn = card.querySelector('.delete-btn');
                    
                    editBtn.addEventListener('click', function () {
                        const newText = card.querySelector('textarea[name="text"]').value; // ดึงข้อความใหม่จาก textarea ที่มีชื่อว่า "text"
                        const newTexth = card.querySelector('textarea[name="texth"]').value; // ดึงข้อความใหม่จาก textarea ที่มีชื่อว่า "texth"
                        sendPostEdit(item.post_id, newText, newTexth);
                    });
                    deleteBtn.addEventListener('click', function () { 
                        if (confirm("คุณต้องการลบหรือไม่?")) {
                            // หากผู้ใช้กดตกลง ให้เปลี่ยนเส้นทางไปยัง index.html
                             // เรียกใช้ฟังก์ชันเพื่อลบไฟล์ภาพ
                            sendPostDelete(item.post_id, item.post_image);
                            // window.location.href = "index.html";
                        } else {
                            // หากผู้ใช้กดยกเลิก ไม่ต้องทำอะไร
                        }
                    });
                });
            })
            .catch(error => console.error('Error:', error));
    }

    // เมื่อเริ่มต้นหน้าเว็บโดยใช้ DOMContentLoaded จะดึงและแสดงข้อมูล
    fetchAndRenderData();

    function sendPostEdit(postId, newText, newTexth) {
        // ส่งข้อมูลไปยัง  พร้อมกับข้อความใหม่จาก textarea
        fetch(`add-event-update.php?post_id=${postId}&new_text=${newText}&new_texth=${newTexth}`, {
            method: 'GET'
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! Status: ${response.status}`);
            }
            return response.text();
        })
        .then(data => {
            // หลังจากส่งข้อมูลไปยัง user-permission-allowed.php สามารถทำสิ่งที่ต้องการได้ตามความต้องการ
            console.log(data);
            // เมื่อคลิกที่ปุ่ม allowed ให้รีเฟรชหน้าเพื่อแสดงข้อมูลใหม่
            fetchAndRenderData();
        })
        .catch(error => {
            console.error('Error:', error);
        });
    }

    function sendPostDelete(postId, postImage) {
        fetch(`add-event-delete.php?post_id=${postId}&post_image=${postImage}`, {
            method: 'GET'
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! Status: ${response.status}`);
            }
            return response.text();
        })
        .then(data => {
            // หลังจากส่งข้อมูลไปยัง user-permission-update.php สามารถทำสิ่งที่ต้องการได้ตามความต้องการ
            console.log(data);
            // เมื่อคลิกที่ปุ่ม allowed ให้รีเฟรชหน้าเพื่อแสดงข้อมูลใหม่
            fetchAndRenderData();
        })
        .catch(error => {
            console.error('Error:', error);
        });
    }
});
</script>